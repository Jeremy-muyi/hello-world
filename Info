import os
import time
import logging
import tkinter as tk
from tkinter import filedialog, messagebox
from PIL import Image
import fitz  # PyMuPDF
import comtypes.client
import pythoncom
import customtkinter as ctk
from datetime import datetime
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
from logging.handlers import RotatingFileHandler

# 配置参数类
class Config:
    DISPLAY_SECONDS = 10
    FOLDER_PATH = r"\\aq3nas01.ap.lilly.com\aq3nas_mfg.grp\ELM_Workspaces\AutoDisplay"
    LOG_FOLDER = r"\\aq3nas01.ap.lilly.com\aq3nas_mfg.grp\ELM_Workspaces\AutoDisplay\Log"
    BACKGROUND = r"\\aq3nas01.ap.lilly.com\aq3nas_mfg.grp\ELM_Workspaces\AutoDisplay\background.png"
    LOG_MAX_SIZE = 5 * 1024 * 1024  # 5MB
    LOG_BACKUP_COUNT = 5
    RETRY_INTERVAL = 3600  # 1小时
    MAX_RETRIES = 3

    @classmethod
    def validate_paths(cls):
        """验证关键路径是否存在"""
        missing = []
        if not os.path.exists(cls.FOLDER_PATH):
            missing.append(f"文件夹路径: {cls.FOLDER_PATH}")
        if not os.path.exists(cls.BACKGROUND):
            missing.append(f"背景图片: {cls.BACKGROUND}")
        if missing:
            raise FileNotFoundError("以下路径不存在:\n" + "\n".join(missing))

class FileChangeHandler(FileSystemEventHandler):
    """文件系统变更处理器"""
    def __init__(self, app):
        super().__init__()
        self.app = app

    def on_modified(self, event):
        """当检测到文件修改时刷新文件列表"""
        if not event.is_directory:
            self.app.refresh_file_list()

class InfoDisplayApp:
    def __init__(self, root):
        self.root = root
        self._init_resources()  # 先初始化资源
        self._init_logging()    # 接着初始化日志
        self._init_ui()         # 然后初始化UI
        self._init_file_monitor()  # 最后初始化文件监控
        
        try:
            self.show_background()
        except Exception as e:
            self.logger.error(f"初始化背景失败: {str(e)}")
            self._show_error_message("无法加载背景图片")

    # ---------- 初始化相关方法 ----------
    def _init_resources(self):
        """初始化资源（确保最先执行）"""
        self.files = []
        self.index = 0
        self.current_pdf = None
        self.pdf_page_index = 0
        self.is_running = False
        self.error_files = set()
        self.recent_failed = {}
        self.default_image = self._load_background()

    def _init_logging(self):
        """初始化日志系统"""
        os.makedirs(Config.LOG_FOLDER, exist_ok=True)
        self.logger = logging.getLogger("DisplayApp")
        self.logger.setLevel(logging.INFO)
        
        if not self.logger.handlers:
            handler = RotatingFileHandler(
                self._get_log_path(),
                maxBytes=Config.LOG_MAX_SIZE,
                backupCount=Config.LOG_BACKUP_COUNT,
                encoding='utf-8'
            )
            formatter = logging.Formatter('[%(asctime)s] %(message)s')
            handler.setFormatter(formatter)
            self.logger.addHandler(handler)

    def _init_ui(self):
        """初始化用户界面"""
        self.root.attributes('-fullscreen', True)
        self.root.tk.call('tk', 'scaling', 2.0)  # 高DPI适配
        ctk.set_appearance_mode("dark")
        ctk.set_default_color_theme("blue")

        # 控制面板
        self.control_frame = ctk.CTkFrame(self.root, fg_color="#344955", height=40)
        self.control_frame.place(relx=0.5, y=0, anchor="n")
        
        # 控制按钮
        controls = [
            ("开始投屏", self.start_display, "blue"),
            ("结束投屏", self.stop_display, "red"),
            ("选择文件夹", self.choose_folder, "green"),
            ("退出程序", self.quit_program, "#a83232")
        ]
        for text, cmd, color in controls:
            btn = ctk.CTkButton(
                self.control_frame, 
                text=text, 
                command=cmd,
                height=32,
                corner_radius=20,
                fg_color=color
            )
            btn.pack(side="left", padx=10, pady=5)

        # 状态显示
        self.status_label = ctk.CTkLabel(
            self.control_frame, 
            text="状态：未开始", 
            text_color="white"
        )
        self.status_label.pack(side="right", padx=10)

        # 主显示区域
        self.label = ctk.CTkLabel(self.root, text="")
        self.label.pack(expand=True, fill="both")

        self.root.after(1000, self._check_mouse_position)

    def _init_file_monitor(self):
        """初始化文件监控"""
        self.observer = Observer()
        self.observer.schedule(
            FileChangeHandler(self),
            Config.FOLDER_PATH,
            recursive=True
        )
        self.observer.start()

    # ---------- 核心功能方法 ----------
    def start_display(self):
        """开始播放"""
        if not self.is_running:
            self.is_running = True
            self.status_label.configure(text="状态：播放中")
            self.files = self._get_supported_files()
            self.index = 0
            self.error_files.clear()
            self.recent_failed.clear()
            self.root.after(3000, self._hide_controls)
            self._show_next()

    def stop_display(self):
        """停止播放"""
        self.is_running = False
        self.status_label.configure(text="状态：已停止")
        self.show_background()

    def choose_folder(self):
        """选择新文件夹"""
        folder = filedialog.askdirectory(initialdir=Config.FOLDER_PATH)
        if folder:
            Config.FOLDER_PATH = folder
            self.stop_display()
            self.refresh_file_list()
            self.start_display()

    def quit_program(self):
        """退出程序"""
        self.logger.info("用户退出程序")
        self.observer.stop()
        self.observer.join()
        if self.current_pdf:
            self.current_pdf.close()
        self.root.destroy()

    # ---------- 文件处理方法 ----------
    def refresh_file_list(self):
        """刷新文件列表"""
        self.files = self._get_supported_files()
        self.logger.info("文件列表已刷新")

    def _get_supported_files(self):
        """获取支持的文件列表"""
        exts = {'.jpg', '.jpeg', '.png', '.bmp', '.pdf', '.ppt', '.pptx'}
        try:
            return sorted([
                os.path.join(Config.FOLDER_PATH, f)
                for f in os.listdir(Config.FOLDER_PATH)
                if os.path.splitext(f)[1].lower() in exts
            ])
        except Exception as e:
            self.logger.error(f"读取文件错误: {str(e)}")
            return []

    # ---------- 显示控制方法 ----------
    def _load_background(self):
        """加载背景图片"""
        try:
            if not os.path.exists(Config.BACKGROUND):
                raise FileNotFoundError(f"背景路径不存在: {Config.BACKGROUND}")
            
            img = Image.open(Config.BACKGROUND)
            return img.resize(
                (self.root.winfo_screenwidth(), 
                 self.root.winfo_screenheight()),
                Image.Resampling.LANCZOS
            )
        except Exception as e:
            self.logger.error(f"背景加载失败: {str(e)}")
            return Image.new(
                'RGB', 
                (self.root.winfo_screenwidth(), 
                 self.root.winfo_screenheight()),
                color=(34, 73, 85)  # 深蓝色背景
            )

    def show_background(self):
        """显示背景图片"""
        if self.default_image:
            img = ctk.CTkImage(
                light_image=self.default_image,
                size=self.default_image.size
            )
            self.label.configure(image=img)
            self.label.image = img

    # ---------- 其他辅助方法 ----------
    def _check_mouse_position(self):
        """检测鼠标位置控制面板显示"""
        try:
            y = self.root.winfo_pointery()
            if y < 50:
                self._show_controls()
            self.root.after(500, self._check_mouse_position)
        except:
            pass

    def _show_controls(self):
        """显示控制面板"""
        self.control_frame.lift()
        self.root.after(3000, self._hide_controls)

    def _hide_controls(self):
        """隐藏控制面板"""
        self.control_frame.lower()

    def _get_log_path(self):
        """获取当日日志文件路径"""
        date_str = datetime.now().strftime("%Y%m%d")
        return os.path.join(
            Config.LOG_FOLDER, 
            f"display_log_{date_str}.txt"
        )

    def _show_error_message(self, message):
        """显示错误信息"""
        error_label = ctk.CTkLabel(
            self.root,
            text=message,
            text_color="red",
            font=("Arial", 24)
        )
        error_label.place(relx=0.5, rely=0.5, anchor="center")

if __name__ == "__main__":
    try:
        Config.validate_paths()
        root = ctk.CTk()
        app = InfoDisplayApp(root)
        root.mainloop()
    except Exception as e:
        error_msg = f"程序启动失败: {str(e)}"
        print(error_msg)
        root = tk.Tk()
        root.withdraw()
        messagebox.showerror("启动错误", error_msg)
